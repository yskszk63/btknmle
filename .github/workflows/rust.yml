name: Rust

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - run: rustup update
    - run: sudo apt update && sudo apt install -y libudev-dev libinput-dev
    - name: Check format
      run: cargo fmt -- --check
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose
    - uses: actions/cache@v1
      with:
        path: ~/.dkrcache
        key: ${{ runner.os }}-dkrcache2-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-dkrcache-
          ${{ runner.os }}-
    - run: |
        curl -L 'https://github.com/docker/buildx/releases/download/v0.3.1/buildx-v0.3.1.linux-amd64' -o ~/.docker/cli-plugins/docker-buildx --create-dirs
        chmod +x ~/.docker/cli-plugins/docker-buildx
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        docker buildx create --use
        docker run --rm --privileged docker/binfmt:66f9012c56a8316f9244ffd7622d7c21c1f6f28d
        ls $HOME/.dkrcache
        if [ -f $HOME/.dkrcache/index.json ]; then
          docker buildx build --cache-from=type=local,src=$HOME/.dkrcache --cache-to=type=local,dest=$HOME/.dkrcache -f build/Dockerfile.armv6 -t yskszk63/btknmle:armv6 . --push
        else
          docker buildx build --cache-to=type=local,dest=$HOME/.dkrcache -f build/Dockerfile.armv6 -t yskszk63/btknmle:armv6 . --push
        fi
        ls $HOME/.dkrcache
      env:
        DOCKER_USERNAME: yskszk63
        DOCKER_PASSWORD: ${{ secrets.DOCKER_TOKEN }}
